Sources: 
https://www.coursera.org/lecture/financial-risk-management-with-r/calculating-daily-returns-jenBp
https://www.coursera.org/lecture/financial-risk-management-with-r/calculating-longer-returns-m1ZnI
```{r}
library(quantmod)
wil<-getSymbols("WILL5000IND",src="FRED",auto.assign=FALSE)
wil<-na.omit(wil)
wil<-wil["1979-12-31/2017-12-31"]
names(wil)<-"TR"
head(wil,3)
tail(wil,3)
logreturn <- diff(log(wil$TR))[-1]
round(head(logreturn, 3),6)


```
daily return : $re$$t_t$$=$$wil_t$$/$$wil_{t-1}$$-1$


A discrete return can never have a value less than -1, but it can take on a positive number greater than 1. This mean that the distrubution of discrete returns cannot have a symetric distrobution, so we should transform by taking the log of the data


$logre$$t_t$$=log(1+$$ret_t$$)$

To get a n-day return simply add up all the daily returns 

```{r}
logreturn_w <- apply.weekly(wil,sum) #also works for monthly, quarterly, and yearly
round(head(logreturn_w,3),6)

mu <- round(mean(logreturn),8)
sigma <- round(sd(logreturn),8)
mu 
sigma
```

Value at risk (VaR): the ammount that the portfolio might lose, with a given probability (1 - alpha) over a given time period (alpha is usually 0.1, o.05 or 0.01) and the time period is usually one day or one week

```{r}
round(qnorm(0.05,mu,sigma),6)
```
The meaning of this number is that over the period of one single day the fund is not likely to loose more than 1.72% of its value at a 95% confidence interval

Expected shortfall (ES): for the same values as VaR, the ES is the expected return given that the return is less than the assoiated VaR; conditional value at risk (CaR), expected tail-loss;

```{r}
ES<-mu-sigma*dnorm(qnorm(0.05,0,1),0,1)/0.05
discreteES<-exp(ES)-1 #converting it back to a discrete return, rather than logarithmic
discreteES
```

The one day expected loss (ES) at the 95% conidence level is -2.14% if the loss is greater than the VaR

Principal: to estimate the alpha-quantile of a distribution, simulate some data, and then calculate the alpha-quantile of the simulation (this goves the VaR at the (1-alpha) confidence interval)

The mean of the data less the VaR is the ES

```{r}
alpha<-0.05
set.seed(123456789)
rvec<-rnorm(10000,mu,sigma)
VaR<-quantile(rvec,alpha)
ES<-mean(rvec[rvec<VaR])
round(VaR,6)
round(ES,6)
plot(density(rvec))
```
Now with replacement, where we replace the sampled in the distribution
This does not assume normality, since we are replacing elements of the data
When we compare the graphs of the rvec from before and after replacement, we can see that replacement causes the distrobution to look less normal

```{r}
alpha<-0.05
set.seed(123456789)
rvec<-sample(as.vector(logreturn),100000,replace=TRUE)
VaR<-quantile(rvec,alpha)
ES<-mean(rvec[rvec<VaR])
round(VaR,6)
round(ES,6)
plot(density(rvec))
```
Kurtosis : over or under thickness of the central point
Coefecient of skewkness: 0 if symetric greater than 0 if right skewed and less than 0 if left skewed
Coeffecient of kurtosis: a measure of the heavness or thickness of the tails of a distribution: 3 for normal : les than 3 for thin-tailed: more than 3 for thick-tailed

```{r}
library(moments)
rvec <- as.vector(logreturn)
round(kurtosis(rvec),3) #heavy-tailed
```
Many ways to test for normality...one is the Jarque-Bera test
```{r}
library(moments)
rvec<-as.vector(logreturn)
jarque.test(rvec) #test for normality
```
Rejects the hypotheseis that the data is normal

Student-t distribution can be used to describe heavy-tailed distributions
The pram v of degrees of freedom DoF controls the 
Student-t always has a mean of 0, coef of skewness 0 as long as v greater than 3
When v is infinite, the distribution is normal N(0,1)
REmember that the kurtosis of the Wil5000 was ~22, so (through some online chart) the v or DoF is ~4.3
BUT, it is unlikely to find a v that matches the sd and kurtosis of the data at the same time
SOLUTION: add in another coeffecient to help solve the problem
:divide every outcome by the sd, which in this case is the sqrt(v/(v-2))
